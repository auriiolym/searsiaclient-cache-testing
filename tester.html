<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Searsia search client" />
    <meta name="author" content="Searsia.org" />
    <link id="favicon" rel="icon" type="image/png" href="images/search.png" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/searsia.css" />
    <title>Search</title>
  </head>

  <body>

    <div class="container-fluid theme-search">

      <div class="row">
        <div class="col-md-8">
          <div class="searsia-icon">
             <a href="index.html"><img src="images/search.png" alt="" /></a>
          </div>
          <div class="searsia-form">
            <form id="searsia-form">
             <div class="input-group">
               <input type="text" name="q" class="form-control" value="" />
                <span class="input-group-btn">
                  <button class="btn btn-default" type="submit" value="submit">
                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                    <span class="sr-only">Search</span>
                  </button>
                </span>
             </div>
            </form>
          </div>
          <div>
            <div class="searsia-top" id="searsia-alert-top"></div>
            <div>&nbsp;</div>
          </div>
        </div>
        <div class="col-md-4">
        </div>
      </div>

      <div class="row">
        <div class="col-md-1">
        </div>
        <div class="col-md-7">
          <div id="searsia-results-1"></div>
          <div id="searsia-results-2"></div>
          <div id="searsia-results-3"></div>
        </div>
        <div class="col-md-3">
          <div id="searsia-sidebar">
          </div>
        </div>
        <div class="col-md-1">
        </div>
      </div>

      <div class="row">
        <div class="col-md-1">
        </div>
        <div class="col-md-7">
          <div id="searsia-results-4"></div>
          <div class="searsia-bottom" id="searsia-alert-bottom">
            <noscript>Enable Javascript and use a modern browser to use Search</noscript>
          </div>
        </div>
        <div class="col-md-4">
        </div>
      </div>

    </div> <!-- /container -->

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/searsia.js"></script>
    <script>
      $(document).ready(function(){
        placeName({ });
        placeIcon({ });
        var params = searsiaUrlParameters();
        if (params.q != '') {
          fillForm(formQuery(params.q));
          document.title += ": " + printableQuery(params.q);
          getResources(params);
        } else {
          //window.location.replace("index.html");
        } 
      });
    </script>
    
    
    <script>
    
    function sleep( durationMs ){
        var now = new Date().getTime(), t=0;
        while (new Date().getTime() < now + durationMs) {t++} 
    }
    
    /**
     * Searsia server comparator.
     * This compares the speed and accuracy of two Searsia servers.
     */
     
    // Settings.
    var queryAmount = 25,
    	runTime = 30, // seconds
    	servers = {
    		controlServer: "http://localhost:16842/searsia/search?q={q?}&r={r?}",
    		testServer 	 : "http://localhost:16843/searsia/search?q={q?}&r={r?}"
    	},
    	testResources = ["tester10s"/*, "tester30s", "tester1m", "tester2m", "tester5m", "tester10m"*/]
    ;
    
    // Declare variables.
    var queryBase,
    	queries = [],
    	q,
    	r,
    	testIterator = -1,
    	startTime,
    	results = [],
    	resourceError = false
    ;
    
    // Build a list of unique queries.
    queryBase = "Query" + new Date().getTime();
    for (var i = 0; i < queryAmount; i++) {
    	queries.push(queryBase + i);
    }
    
    // Check if all resources are registered on the servers.
    for (var i in testResources) {
    	for (var s in servers) {
    	    $.ajax({
    	        url: fillUrlTemplate(servers[s], "", testResources[i]),
    	        error: function (xhr, options, err) {
    	        	console.log("Resource " + testResources[i] + " is not found "
    	        	      	  + "on server " + s);
    	        	resourceError = true;
    	        },
    	        timeout: 12000,
    	        dataType: 'json',
    	        async: false
    	    });
    	}
    }
    if (resourceError) {
    	throw 'error: resource(s) not found';
    }
    
    // Start the timer.
    startTime = new Date().getTime();
    while (new Date().getTime() < startTime + runTime * 1000) {
    	results[++testIterator] = {};
    	
    	// Loop through all test queries.
    	for (var j in queries) {
    		q = queries[j];
    		results[testIterator][q] = {};
    		
    		//Loop through all resources.
    		for (var k in testResources) {
    			r = testResources[k];
    			results[testIterator][q][r] = {};
    			
    			// Execute query on servers.
    			var responseData = {};
    			for (var s in servers) {
    				responseData[s] = executeQuery(s, q, r);
    			}
    			
    			// Compare results.
    			results[testIterator][q][r]['accurate'] = isEqual(responseData, Object.keys(servers));
    			
    			// Sleep to give the servers some time.
    			sleep(200);
    		}
    	}
    }
    console.log(results);
    
    
    /**
     * Check if the values of the object are equal. It only checks the keys that are passed in the second
     * parameter. If any value is null or undefined, false is returned.
     *
     * @param obj 	object	the object of which the values will be compared to each other
     * @param keys	array	the keys of the object that should be checked
     * @return boolean		true if all values corresponding to the keys are equal to each other; false if
     *						any value is null or if a key is undefined
     */
    function isEqual(obj, keys) {
		var isEqual = true;
		// Get the baseline data (the first value in the object).
		var baselineData = JSON.stringify(obj[keys[0]]);
		// Compare with each value (including itself).
		for (var i = 0; i < keys.length; i++) {
			if (!(keys[i] in obj) || obj[keys[i]] === null || JSON.stringify(obj[s]) !== baselineData) {
				isEqual = false;
			}
		}
		return isEqual;
    }
    
    
    /**
     * Execute a query via a server on a resource. The response time and possible errors are saved
     * to the results variable. To do that, it also needs access to the testIterator variable.
     *
     * @param server 	string	the server key as it can be found in the servers variable
     * @param q			string	the query string
     * @param r			string	the resource identifier
     * @return			string	the response data
     */
    function executeQuery(server, q, r) {
		var responseData = null;
		var timeMark = new Date().getTime();
	    $.ajax({
	        url: fillUrlTemplate(servers[server], q, r),
	        success: function (data) { 
	        	responseData = data;
	        	// Save response time.
	        	results[testIterator][q][r][server] = {
        			responseTime: new Date().getTime() - timeMark,
					error: false
	        	}
	        },
	        error: function (xhr, options, err) {
	        	responseData = null;
	        	// Indicate error.
	        	results[testIterator][q][r][server] = {
        			responseTime: null,
					error: true
	        	}
	        },
	        timeout: 12000,
	        dataType: 'json',
	        async: false
	    });
	    return responseData;
    }
    
    
    </script>

  </body>
</html>

