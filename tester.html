<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Searsia search client" />
    <meta name="author" content="Searsia.org" />
    <link id="favicon" rel="icon" type="image/png" href="images/search.png" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/searsia.css" />
    <title>Search</title>
  </head>

  <body>

    <div class="container-fluid theme-search">

      <div class="row">
        <div class="col-md-8">
          <div class="searsia-icon">
             <a href="index.html"><img src="images/search.png" alt="" /></a>
          </div>
          <div class="searsia-form">
            <form id="searsia-form">
             <div class="input-group">
               <input type="text" name="q" class="form-control" value="" />
                <span class="input-group-btn">
                  <button class="btn btn-default" type="submit" value="submit">
                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                    <span class="sr-only">Search</span>
                  </button>
                </span>
             </div>
            </form>
          </div>
          <div>
            <div class="searsia-top" id="searsia-alert-top"></div>
            <div>&nbsp;</div>
          </div>
        </div>
        <div class="col-md-4">
        </div>
      </div>

      <div class="row">
        <div class="col-md-1">
        </div>
        <div class="col-md-7">
          <div id="searsia-results-1"></div>
          <div id="searsia-results-2"></div>
          <div id="searsia-results-3"></div>
        </div>
        <div class="col-md-3">
          <div id="searsia-sidebar">
          </div>
        </div>
        <div class="col-md-1">
        </div>
      </div>

      <div class="row">
        <div class="col-md-1">
        </div>
        <div class="col-md-7">
          <div id="searsia-results-4"></div>
          <div class="searsia-bottom" id="searsia-alert-bottom">
            <noscript>Enable Javascript and use a modern browser to use Search</noscript>
          </div>
        </div>
        <div class="col-md-4">
        </div>
      </div>

    </div> <!-- /container -->

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/searsia.js"></script>
    <script>
      $(document).ready(function(){
        placeName({ });
        placeIcon({ });
        var params = searsiaUrlParameters();
        if (params.q != '') {
          fillForm(formQuery(params.q));
          document.title += ": " + printableQuery(params.q);
          getResources(params);
        } else {
          //window.location.replace("index.html");
        } 
      });
    </script>
    
    
    <script>
    
    
    /**
     * Searsia server comparator.
     * This compares the speed and accuracy of two Searsia servers.
     */
     
    // Settings.
    var queryAmount = 25, // different query strings
    	runTime = 30, // seconds
    	delay = 200, // delay after each query request to the set of servers (in milliseconds)
    	servers = {
    		controlServer: "http://localhost:16842/searsia/",
    		testServer 	 : "http://localhost:16843/searsia/"
    	},
    	
    	// The template that will be supplemented and overwritten.
    	resourceTemplate = {
    		resource: {
 				mimetype: "text/html",
 				testquery: "searsia",
 				itempath: "//li",
 				extractors: { title: "." }
    		},
    		searsia: "v0.4.0"
   		},
   		// The values (per resouce) will supplement and overwrite resourceTemplate.
   		// The id will be the same as the key.
    	resources = {
    		tester10s: {
    			apitemplate: "http://karim.elass.al/searsia-customresource/?ttl=10&q={q}"
    		},
    		tester20s: {
    			apitemplate: "http://karim.elass.al/searsia-customresource/?ttl=20&q={q}"
    		},
    		tester30s: {
    			apitemplate: "http://karim.elass.al/searsia-customresource/?ttl=30&q={q}"
    		}
    	}
    ;
    
    // Declare global variables.
    var queries = [],
    	testIterator = -1,
    	results = [],
    	resourceError = false
    ;
    
    // Set default request settings.
    $.ajaxSetup({
    	type: "GET",
    	timeout: 10000,
        dataType: 'json',
    	async: false
    });
    
    // Build a list of unique queries.
    var queryBase = "Query" + new Date().getTime();
    for (var i = 0; i < queryAmount; i++) {
    	queries.push(queryBase + i);
    }
    
    // Check if all resources are registered on the servers and if not, try to add them.
    for (var r in resources) {
    	for (var s in servers) {
    		if (!hasResource(s, r)) {
    			if (addResource(s, r)) {
    				console.log("Resource " + r + " was added to server " + s + ".");
    			} else {
    				resourceError = true;
    			}
    		}
    	}
    }
    if (resourceError) {
    	throw 'error: resource(s) not found and unable to add to server(s).';
    }
    
    // Start the timer.
    var startTime = new Date().getTime();
    while (new Date().getTime() < startTime + runTime * 1000) {
    	results[++testIterator] = {};
    	
    	// Loop through all test queries.
    	for (var j in queries) {
    		var q = queries[j];
    		results[testIterator][q] = {};
    		
    		// Loop through all resources.
    		for (var r in resources) {
    			results[testIterator][q][r] = {};
    			
    			// Execute query on servers.
    			var responseData = {};
    			for (var s in servers) {
    				responseData[s] = executeQuery(s, q, r);
    			}
    			
    			// Compare results.
    			results[testIterator][q][r]['accurate'] = isEqual(responseData, Object.keys(servers));
    			
    			// Sleep to give the servers some time.
    			sleep(delay);
    		}
    	}
    }
    console.log("Raw results: ", results);
    
    // Tests are done!
    
    
    
    /** 
     * Now make something of the results.
     * We want:
     *  - average response time per server and per resource
     *  - average response time per server
     *  - accuracy per resource
     *
     * This is the data available:
     *  results[testIterator][query][resource][server].responseTime
     *  results[testIterator][query][resource][server].error
     *  results[testIterator][query][resource].accurate
     * 
     * So first reformat to:
     *  reformattedData[server][resource][] = responseTime
     *  accuracyData[resource][] = accurate
     */
    
    var reformattedData = {},
    	accuracyData = {},
    	avgResponseTimes = {},
    	avgServerResponseTimes = {},
    	accuracies = {}
    ;
    for (var i in results) {
    	for (var q in results[i]) {
    		for (var r in results[i][q]) {
    			for (var s in servers) {
    				reformattedData[s] = reformattedData[s] || {};
    				reformattedData[s][r] = reformattedData[s][r] || [];
    				if (results[i][q][r][s].error === false) {
    					reformattedData[s][r].push(results[i][q][r][s].responseTime);
    				}
    			}
    			accuracyData[r] = accuracyData[r] || [];
    			if (results[i][q][r].accurate !== null) {
    				accuracyData[r].push(results[i][q][r].accurate);
    			}
    		}
    	}
    }
    console.log("Reformatted data: ", reformattedData);
    console.log("Accuracy data:    ", accuracyData);
    
    // Now calculate the average response time per server per resource and per server.
    // I also transpose the matrix, so it can be analysed more easily.
    // Result formats:	
    //	avgResponseTimes[resource][server] = avg response time
    //  avgServerResponseTime[server] = avg response time
    for (var s in reformattedData) {
        var serverTotalResponseTime = 0;
        var serverTotalMeasurePoints = 0;
    	for (var r in reformattedData[s]) {
    		avgResponseTimes[r] = avgResponseTimes[r] || {};
    		var sum = reformattedData[s][r].reduce(function(a,b){return a+b;});
    		
    		avgResponseTimes[r][s] = sum / reformattedData[s][r].length;
    		
    		serverTotalResponseTime += sum;
    		serverTotalMeasurePoints += reformattedData[s][r].length;
    	}
    	avgServerResponseTimes[s] = serverTotalResponseTime / serverTotalMeasurePoints;
    }
    console.log("Average response times: ", avgResponseTimes);
    console.log("Average server response times: ", avgServerResponseTimes);
    
    // Calculate the accuracy.
    // Result format:
    //  accuracies[resource] = percent accurate
    for (r in accuracyData) {
    	var accurate = 0;
    	var inaccurate = 0;
    	for (i in accuracyData[r]) {
    		if (accuracyData[r][i] === true) {
    			accurate++;
    		} else if (accuracyData[r][i] === false) {
    			inaccurate++;
    		}
    	}
    	accuracies[r] = accurate / (accurate + inaccurate);
    } 
    console.log("Accuracies: ", accuracies);
    
    
    
    
    
    

    
    /**
     * Return a complete resource object, built up from the resourceTemplate and resources settings.
     *
     * @param rid	string	the resource identifier
     * @return 		object	the resource object
     */
    function getResource(rid) {
    	return jQuery.extend(true, {}, resourceTemplate,
   			{ resource: { id: rid } },
   			{ resource: resources[rid] }
 		);
    }
    
    /**
     * Check if a server has a specific resource.
     *
     * @param server	string	the server id, as can be found in the settings of this script
     * @param resource	string	the resource id
     * @return 			boolean
     */
    function hasResource(server, resource) {
    	var result = true;
	    $.ajax({
	        url: fillUrlTemplate(getSearchTemplate(s), "", resource),
	        error: function (xhr, options, err) {
	        	result = false;
	        }
	    });
	    return result;
	}
    
    
    /**
     * Add a resource to a server.
     *
     * @param server 	string	the server id, as can be found in the settings of this script
     * @param resource	string	the resource identifier
     * @return 			boolean true if adding succeeded
     */
    function addResource(server, resource) {
    	var result,
    		resourceObject = getResource(resource)
   		;
    	
    	$.ajax({
            url: getUpdateTemplate(server) + resource, 
            type: 'PUT',
            contentType: 'application/searsia+json; charset=utf-8',
            data: JSON.stringify(resourceObject),
            success: function (data, textStatus, jqXHR) {
				result = true;
            },
            error: function (jqXHR, textStatus, errorThrown) {
            	console.log("Update failed.\n" + jqXHR.status + " " + jqXHR.statusText + ".\n");
            	console.log(jqXHR.responseJSON);
            	result = false;
            }
        });
    	return result;
    }
    
    
    /**
     * Check if the values of the object are equal. It only checks the keys that are passed in the second
     * parameter. If any value is null or undefined, false is returned.
     *
     * @param obj 	object	the object of which the values will be compared to each other
     * @param keys	array	the keys of the object that should be checked
     * @return 		boolean true if all values corresponding to the keys are equal to each other; false if
     *						any value is null or if a key is undefined
     */
    function isEqual(obj, keys) {
		var isEqual = true;
		// Get the baseline data (the first value in the object).
		var baselineData = JSON.stringify(obj[keys[0]]);
		// Compare with each value (including itself).
		for (var i = 0; i < keys.length; i++) {
			if (!(keys[i] in obj) || obj[keys[i]] === null || JSON.stringify(obj[s]) !== baselineData) {
				isEqual = false;
			}
		}
		return isEqual;
    }
    
    
    /**
     * Execute a query via a server on a resource. The response time and possible errors are saved
     * to the results variable. To do that, it also needs access to the testIterator variable.
     *
     * @param server 	string	the server id, as can be found in the settings of this script
     * @param q			string	the query string
     * @param r			string	the resource identifier
     * @return			string	the response data
     */
    function executeQuery(server, q, r) {
		var responseData = null;
		var timeMark = new Date().getTime();
	    $.ajax({
	        url: fillUrlTemplate(getSearchTemplate(server), q, r),
	        success: function (data) { 
	        	responseData = data;
	        	// Save response time.
	        	results[testIterator][q][r][server] = {
        			responseTime: new Date().getTime() - timeMark,
					error: false
	        	}
	        },
	        error: function (xhr, options, err) {
	        	// Indicate error.
	        	results[testIterator][q][r][server] = {
        			responseTime: null,
					error: true
	        	}
	        }
	    });
	    return responseData;
    }
     


    /**
     * Return the server's API search template.
     *
     * @param server 	string	the server id, as can be found in the settings of this script
     * @return 			string
     */
    function getSearchTemplate(server) {
    	return servers[server] + "search?q={q?}&r={r?}";
    }

    /**
     * Return the server's API update template.
     *
     * @param server 	string	the server id, as can be found in the settings of this script
     * @return 			string
     */
    function getUpdateTemplate(server) {
    	return servers[server] + "update/";
    }

    /**
     * Sleep for a while.
     *
     * @param durationMs 	int		the amount of milliseconds to sleep
     */
    function sleep( durationMs ){
        var now = new Date().getTime(), t=0;
        while (new Date().getTime() < now + durationMs) {t++;} 
    }
    
    
    </script>

  </body>
</html>

